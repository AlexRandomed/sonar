var admin=function(){var b=function(e){return{list:_.values(e.result)}};var a=function(e){for(obj in e.result){e.result[obj]["notActivated"]=e.result[obj].code===""?false:true;e.result[obj]["isProfessor"]=e.result[obj].type==="Teacher"?true:false;e.result[obj]["isRelative"]=e.result[obj].type==="Relative"?true:false}return{list:_.values(e.result)}};var c=Object.create(protoApp);c.scope="#annuaire";c.define({template:{ecole:"				{{#list}}<h3>{{name}}</h3>				<a call='classes' href='api/classes?id={{id}}'>				{{#i18n}}directory.admin.see-classes{{/i18n}}</a> - 				<a href='api/export?id={{id}}'>				{{#i18n}}directory.admin.exports{{/i18n}}</a>				<div id='classes-{{id}}'></div>{{/list}}",classes:"				{{#list}}<h4><a>{{name}}</a></h4>				<a call='personnes' href='api/personnes?id={{classId}}'>				{{#i18n}}directory.admin.see-people{{/i18n}}</a>				 - <a href=\"{{classId}}\" call=\"addUser\">				{{#i18n}}directory.admin.create-user{{/i18n}}</a>				 - <a href='api/export?id={{classId}}'>				{{#i18n}}directory.admin.exports{{/i18n}}</a><br />				<div id='people-{{classId}}'></div>{{/list}}",personnes:"				<br /><span>					{{#list}}					<a call='personne' href='api/details?id={{userId}}'						style='							{{#notActivated}}color:red;{{/notActivated}}							{{#isProfessor}}font-weight:bold;{{/isProfessor}}							{{#isRelative}}font-style:italic;{{/isRelative}}						'					>					{{lastName}} {{firstName}}</a> - 					{{/list}}				</span><div id='details'></div>",personne:'				{{#list}}{{#i18n}}directory.admin.login{{/i18n}} : {{login}} / {{code}} - 				{{#i18n}}directory.admin.address{{/i18n}} : {{address}} - 				<a call="sendResetPassword" href="{{login}}">{{#i18n}}directory.admin.reset.password{{/i18n}}</a> {{/list}}',personnesEcole:'				{{#list}}<input type="checkbox" name="{{userId}}" value="{{userId}}"/>				{{lastName}} {{firstName}} - {{/list}}',addUser:'<span>{{#i18n}}directory.admin.create-user{{/i18n}}</span>				<form action="api/user">				<input type="hidden" name="classId" value="{{classId}}" />				<label>{{#i18n}}directory.admin.lastname{{/i18n}}</label>				<input type="text" name="lastname" />				<label>{{#i18n}}directory.admin.firstname{{/i18n}}</label>				<input type="text" name="firstname" />				<label>{{#i18n}}directory.admin.type{{/i18n}}</label>				<select name="type">					<option value="Teacher">{{#i18n}}directory.admin.teacher{{/i18n}}</option>					<option value="Student">{{#i18n}}directory.admin.student{{/i18n}}</option>					<option value="Relative">{{#i18n}}directory.admin.parent{{/i18n}}</option>				</select>				<select name="childrenIds" multiple>				{{#childrens}}					<option value="{{userId}}">{{firstName}} {{lastName}}</option>				{{/childrens}}				</select>				<input call="addUserSubmit" type="button" value="{{#i18n}}directory.admin.create{{/i18n}}" />			</form>',sendResetPassword:'			    <form action="/auth/sendResetPassword">			        <label>{{login}}</label>                    <input type="hidden" name="login" value="{{login}}" />                    <label>{{#i18n}}directory.admin.email{{/i18n}}</label>                    <input type="text" name="email" />                    <input call="sendResetPasswordSubmit" type="button" value="{{#i18n}}directory.admin.send{{/i18n}}" />            	</form>'},action:{ecole:function(d){if(!!$("#schools").children().length){$("#schools").html("");return}c.template.getAndRender(d.url,"ecole","#schools",b)},classes:function(d){$.get(d.url).done(function(e){if(undefined!==e.result[0]){if(!!$("#classes-"+e.result[0]["schoolId"]).children().length){$("#classes-"+e.result[0]["schoolId"]).html("");return}$("#classes-"+e.result[0]["schoolId"]).html(c.template.render("classes",b(e)))}else{c.notify.info("Aucun r√©sultat")}}).error(function(e){c.notify.error(e)})},personnesEcole:function(d){c.template.getAndRender(d.url,"personnesEcole","#users",b)},personnes:function(d){$.get(d.url).done(function(e){if(!!$("#people-"+e.result[0]["classId"]).children().length){$("#people-"+e.result[0]["classId"]).html("");return}$("#people-"+e.result[0]["classId"]).html(c.template.render("personnes",a(e)))}).error(function(e){c.notify.error(e)})},personne:function(d){if(!!$("#details").children("form").length){$("#details").html("");return}c.template.getAndRender(d.url,"personne","#details",b)},addUser:function(d){$.get("api/personnes?id="+d.url+"&type=Student").done(function(e){var g=[];if(e.status==="ok"){for(var f in e.result){g.push(e.result[f])}$("#people-"+d.url).html(c.template.render("addUser",{classId:d.url,childrens:g}))}})},addUserSubmit:function(e){var d=$(e.target).parents("form");$.post(d.attr("action"),d.serialize()).done(function(f){if(f.status==="ok"){$("#people-"+d.children("input[name='classId']").attr("value")).empty();c.notify.done(c.i18n.bundle["directory.admin.user.created"])}else{c.notify.error(f.message)}}).error(function(f){c.notify.error(f)})},sendResetPassword:function(d){$("#details").html(c.template.render("sendResetPassword",{login:d.url}))},sendResetPasswordSubmit:function(e){var d=$(e.target).parents("form");$.post(d.attr("action"),d.serialize()).done(function(f){c.notify.done(c.i18n.bundle["directory.admin.reset.code.sent"])}).error(function(f){c.notify.error(c.i18n.bundle["directory.admin.reset.code.send.error"])})}}});return c}();$(document).ready(function(){admin.init()});