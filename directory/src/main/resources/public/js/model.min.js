function User(a){this.updateData(a);this.relatives=[];this.select=function(){var b=this;http().get("/userbook/api/person?id="+this.id+"&type="+this.type).done(function(c){c.result[0].hobbies=_.map(c.result[0].category,function(d,e){return{category:d,value:c.result[0].values[e]}});c.result[0].relatives=_.map(c.result,function(d){return new User({displayName:d.relatedName,id:d.relatedId,type:d.relatedType})});c.result[0].relatives=_.filter(c.result[0].relatives,function(d){return d.id!==""});b.selected=true;b.updateData(c.result[0]);model.directory.users.setCurrent(b);model.myClass.users.setCurrent(b)})};this.deselect=function(){this.selected=false;model.directory.users.setCurrent(undefined);model.myClass.users.setCurrent(undefined)}}User.prototype.saveUserbook=function(){http().putJson("/directory/userbook/"+this.id,{health:this.health,hobbies:this.hobbies,picture:this.picture})};User.prototype.saveUserbookProperty=function(b){var a={};a[b]=this[b];if(b==="mood"){a.mood=a.mood.id}http().putJson("/directory/userbook/"+this.id,a)};User.prototype.saveInfos=function(){var a={displayName:this.displayName,firstName:this.firstName,lastName:this.lastName,address:this.address,email:this.email,homePhone:this.homePhone,birthDate:moment(this.birthDate).format("YYYY-MM-DD")};if(this.type==="Relative"){a.childrenIds=_.map(this.relatives,function(b){return b.id})}http().putJson("/directory/user/"+this.id,a)};User.prototype.saveVisibility=function(){};User.prototype.saveChanges=function(){if(this.edit.userbook){this.saveUserbook()}if(this.edit.infos){this.saveInfos()}};User.prototype.saveAccount=function(){var a={lastName:this.lastName,firstName:this.firstName,type:this.type,birthDate:moment(this.birthDate).format("YYYY-MM-DD")};if(this.type==="Relative"){a.childrenIds=_.map(this.relatives,function(b){return b.id})}http().postJson("/directory/class/"+model.me.classes[0]+"/user",a).done(function(b){this.updateData(b)}.bind(this))};User.prototype.thumbs="thumbnail=290x290&thumbnail=82x82&thumbnail=48x48&thumbnail=100x100";User.prototype.moods=["default","happy","proud","dreamy","love","tired","angry","worried","sick","joker","sad"];User.prototype.loadUserbook=function(){this.pictureVersion=0;http().get("/directory/userbook/"+this.id).done(function(a){if(!a.mood){a.mood="default"}a.mood=_.findWhere(User.prototype.moods,{id:a.mood});a.photo={};if(this.edit.visibility){this.loadVisibility()}this.updateData(a)}.bind(this))};User.prototype.loadVisibility=function(){http().get("/userbook/api/person").done(function(a){this.updateData({schoolName:a.result[0].schoolName,hobbies:_.map(this.hobbies,function(c,b){c.visibility=a.result[0].visibility[b];return c}),visible:{email:a.result[0].visibleInfos.indexOf("SHOW_EMAIL")!==-1?"public":"prive",mail:a.result[0].visibleInfos.indexOf("SHOW_MAIL")!==-1?"public":"prive",phone:a.result[0].visibleInfos.indexOf("SHOW_PHONE")!==-1?"public":"prive",birthdate:a.result[0].visibleInfos.indexOf("SHOW_BIRTHDATE")!==-1?"public":"prive",health:a.result[0].visibleInfos.indexOf("SHOW_HEALTH")!==-1?"public":"prive"}})}.bind(this))};User.prototype.loadInfos=function(){http().get("/directory/user/"+this.id).done(function(a){if(this.edit.visibility&&!this.edit.userbook){this.loadVisibility()}this.updateData(a)}.bind(this))};User.prototype.load=function(){this.loadInfos();if(this.edit.userbook){this.loadUserbook()}};User.prototype.uploadAvatar=function(){var a=new FormData();a.append("image",this.photo[0]);http().postFile("/workspace/document?application=userbook&protected=true&"+User.prototype.thumbs,a,{requestName:"photo"}).done(function(b){this.updateData({picture:b._id});this.pictureVersion++;this.saveChanges();ui.updateAvatar()}.bind(this))};User.prototype.toString=function(){if(this.displayName){return this.displayName}if(this.firstName&&this.lastName){return this.firstName+" "+this.lastName}};User.prototype.removeRelative=function(a){this.relatives=_.reject(this.relatives,function(b){return b.id===a.id})};function MyClass(){this.name="";this.collection(User,{sync:function(){var a=this;http().get("/userbook/api/class").done(function(b){a.load(_.map(b.result,function(c){if(!c.mood){c.mood="default"}return c}))})},match:function(b){var a=lang.removeAccents(b).toLowerCase();if(!a){return this.all}return _.filter(this.all,function(e){var c="",g="",d="",f="";if(e.displayName){c=lang.removeAccents(e.displayName).toLowerCase();if(e.displayName.split(" ").length>0){g=lang.removeAccents(e.displayName.split(" ")[1]+" "+e.displayName.split(" ")[0]).toLowerCase()}}if(e.firstName&&e.lastName){d=lang.removeAccents(e.firstName+" "+e.lastName).toLowerCase();f=lang.removeAccents(e.lastName+" "+e.firstName).toLowerCase()}return c.indexOf(a)!==-1||g.indexOf(a)!==-1||d.indexOf(a)!==-1||f.indexOf(a)!==-1})}})}function Directory(){this.collection(User,{match:function(){return this.all},searchDirectory:function(b){var c=this;var a=lang.removeAccents(b).toLowerCase();this.loading=true;http().get("/userbook/api/search?name="+a).done(function(d){c.loading=false;c.load(_.map(d.result,function(e){if(!e.mood){e.mood="default"}return e}))})}})}function ClassAdmin(){this.sync=function(){http().get("/directory/class/"+model.me.classes[0]).done(function(a){this.id=model.me.classes[0];this.updateData(a)}.bind(this));this.users.sync()};this.saveClassInfos=function(){http().putJson("/directory/class/"+this.id,{name:this.name,level:this.level})};model.directory.users.searchDirectory("");this.collection(User,{sync:function(){http().get("/directory/class/"+model.me.classes[0]+"/users",{requestName:"loadingUsers"}).done(function(a){a.sort(function(d,c){return d.lastName>c.lastName?1:-1});this.load(a)}.bind(this))}});this.importFile=function(a,b){var c=new FormData();c.append("file",a);http().postFile("/directory/csv/"+b+"/class/"+this.id,c).done(function(){this.sync()}.bind(this))};this.addUser=function(a){a.saveAccount();model.classAdmin.sync();model.directory.sync()};this.grabUser=function(a){http().put("/directory/class/"+this.id+"/add/"+a.id).done(function(){model.classAdmin.sync()})};this.blockUsers=function(a){this.users.selection().forEach(function(b){b.blocked=a;http().putJson("/auth/block/"+b.id,{block:a})})};this.resetPasswords=function(){this.users.selection().forEach(function(a){http().post("/auth/sendResetPassword",{login:a.login,email:model.me.email})})}}model.build=function(){this.makeModels([User,MyClass,Directory,ClassAdmin]);this.myClass=new MyClass();this.directory=new Directory();this.classAdmin=new ClassAdmin();http().get("/userbook/api/person").done(function(a){model.me.email=a.result[0].email});User.prototype.moods=_.map(User.prototype.moods,function(a){return{icon:a,text:lang.translate("userBook.mood."+a),id:a}})};